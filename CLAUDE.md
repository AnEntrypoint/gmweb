# Technical Caveats & Gotchas

## Core Architecture

### LinuxServer Webtop + nginx + Selkies

**Base Image:** `lscr.io/linuxserver/webtop:ubuntu-xfce`

- Webtop web UI listens on port 3000 internally (CUSTOM_PORT=6901 is external config only)
- nginx listens on ports 80/443 (HTTP/HTTPS with HTTP Basic Auth reverse proxy, pre-installed in LinuxServer)
- Selkies WebSocket streaming on port 8082
- Traefik/Coolify routes external domain to container:80

**Port 80/443:** nginx provides the primary entry point with built-in HTTP Basic Auth:
- Root `/` → AionUI on port 25808
- `/desk/` → Selkies desktop
- `/ssh/` → webssh2 (ttyd) web terminal on port 9999

### nginx Implementation

**Critical constraint:** nginx is pre-installed in LinuxServer Webtop base image.

- Configuration: Static template at `docker/nginx-sites-enabled-default`
- Routes `/desk/websockets?` to Selkies WebSocket at `127.0.0.1:8082`
- Routes `/desk/` to Selkies web UI at `/usr/share/selkies/web/`
- Routes `/ssh/` to webssh2 (ttyd) at `127.0.0.1:9999`
- Routes `/devmode` to development server (port 5173)
- Routes `/` (catch-all) to AionUI at `127.0.0.1:25808`

**Why static nginx config:** nginx pre-installed, no additional process management needed, supports HTTP/1.1 upgrades and WebSocket proxying, HTTPS via Traefik/Let's Encrypt.

### Environment Variables

**PASSWORD (CRITICAL - All Authentication):**
- LinuxServer environment variable PASSWORD controls all authentication
- **nginx:** HTTP Basic Auth htpasswd generated from PASSWORD at startup
  - Format: `abc:PASSWORD` (apr1 hashed)
  - Protects all routes: /, /ssh/, /desk/, /files/, etc.
  - Generated by: `custom_startup.sh` → `/etc/nginx/.htpasswd`
- **AionUI:** Uses AIONUI_PASSWORD env var (falls back to PASSWORD)
  - Database credentials set 8 seconds after startup
  - Logged as: `[aion-ui] Credentials set: admin`
- **All services:** Supervisor passes PASSWORD via environment to all service processes
- **Verification:** All endpoints require HTTP Basic Auth (username: `abc`, password: `$PASSWORD`)

**CUSTOM_PORT:**
- External configuration only (6901 for direct VNC if needed)
- Internal Webtop always listens on port 3000
- Setting CUSTOM_PORT does NOT change internal routing

## Startup System

### Service Startup Order

1. **nginx** - Starts automatically by LinuxServer s6 supervision system
2. **Desktop services** (xorg, xfce, selkies) - Started by s6
3. **gmweb supervisor** - Started via `/custom-cont-init.d/01-gmweb-init`
4. **Additional services** - Started by gmweb supervisor

**Critical:** nginx handles HTTP/HTTPS with Basic Auth before any other services. All endpoints protected.

### Init Script Must Exit

**GOTCHA:** The `/custom-cont-init.d/01-gmweb-init` script MUST exit (not infinite loop). If it blocks, s6-rc never proceeds to start desktop services (xorg, xfce, selkies).

**Why:** LinuxServer's s6 init system waits for custom init to complete. Blocking prevents desktop environment from launching.

## Critical Technical Caveats

### Port Forwarding Caveat

**GOTCHA:** CUSTOM_PORT is external only. Internal routing uses hardcoded ports:
- `/desk/*` → port 8082 (Selkies)
- All other routes → port 3000 (Webtop)

Using `parseInt(process.env.CUSTOM_PORT)` for upstream routing will send traffic to wrong port (6901 instead of 3000).

### Supervisor Health Check

**GOTCHA:** Health check must reference enabled services. Checking disabled services causes health check to never detect supervisor (2-minute startup timeout).

### Supervisor Initialization Blocking

**GOTCHA:** The `monitorHealth()` function is infinite loop. If awaited in `supervisor.start()`, init hangs forever.

**Fix:** Run `monitorHealth()` as fire-and-forget background task. Use `await new Promise(() => {})` to block supervisor startup properly without awaiting infinite loop.

### nginx Path Stripping with Regex

**CRITICAL CONSTRAINT:** nginx cannot use `proxy_pass` with URI part in regex locations.

**Error:** `"proxy_pass" cannot have URI part in location given by regular expression`

**Workaround:** Use `rewrite` directive before proxy_pass:
```nginx
location ~ /desk/websockets? {
  rewrite ^/desk/websockets?(.*) $1 break;
  proxy_pass http://127.0.0.1:8082;  # No URI part - rewrite stripped it
}
```

### Selkies WebSocket Endpoints

**GOTCHA:** Selkies client attempts both `/desk/websocket` (singular) and `/desk/websockets` (plural).

**Before fix:** nginx only had `location /desk/websocket` (singular) - plural requests failed.

**After fix:** Use regex `location ~ /desk/websockets?` to match both. Use rewrite to strip path, then proxy to bare port (no URI).

### Docker Build Performance

**CRITICAL:** Dockerfile no longer installs anything at build time. All tool installations deferred to runtime via `custom_startup.sh`.

**Why:** Build time reduced from 4+ minutes to ~2 seconds. Image size reduced 5.17GB → 4.15GB. Cache-friendly for config changes.

**Implication:** Every container startup re-runs installation checks. First boot does installs (NVM, Node, packages). Subsequent boots use cache (fast). If install fails, system keeps running (background process).

**Startup phases (custom_startup.sh):**
1. Quick init: Permissions, paths, config (instant)
2. Node.js: Install if not present (1st boot)
3. Supervisor: Fetch repo, npm install (1st boot)
4. Start supervisor: Service manager (every boot)
5. Background installs: System packages + tools (non-blocking)
   - nginx/desktop ready immediately
   - Tools install while UI available
   - Tool failures don't crash system

### Node.js Path Resolution - Dynamic Only

**CRITICAL:** Never hardcode Node.js version paths (e.g., `/nvm/versions/node/v23.11.1/bin`).

**In JS files:** Use `process.execPath` for node binary, `dirname(process.execPath)` for bin directory containing node/npm/npx.

**In shell scripts:** Use `$(which node)`, `$(node -v)`, and `$NVM_DIR/versions/node/$(node -v)/bin` for dynamic resolution.

**Why:** NVM installs whatever version is current. Hardcoded version strings break when Node updates or when NVM installs a different version than expected.

### Persistent Volume Log Caching

**GOTCHA:** Old logs in persistent `/config/logs` volume are cached across container restarts. Reading log file shows stale data from previous deployment.

**Example:** start.sh shows first 30 lines (old boot logs), not last 50 lines (new boot logs).

**Caveat:** Cannot determine if new code actually executed without boot timestamp verification.

### SSH via webssh2 (Direct sshd Removed)

**Note:** sshd service completely removed from startup. webssh2 provides SSH via web browser, reduces attack surface by avoiding direct SSH port exposure. All traffic through nginx HTTP/HTTPS with Basic Auth.

### Selkies WebSocket Path Routing - nginx Regex Constraint

**CRITICAL GOTCHA:** nginx regex locations (`location ~`) cannot use `proxy_pass` with URI part (including trailing slash).

**Error:** `"proxy_pass" cannot have URI part in location given by regular expression`

**Working solution:** Use `rewrite` directive to strip path, then bare `proxy_pass`:
```nginx
location ~ /desk/websockets? {
  rewrite ^/desk/(.*) /$1 break;
  proxy_pass http://127.0.0.1:8082;  # No URI part
}
```

**Why this works:**
- `rewrite` directive modifies the URI before proxy_pass
- `break` flag prevents further rewrite rule processing
- `proxy_pass` without trailing slash preserves the rewritten path
- Selkies backend receives `/websockets` endpoint as expected

**Why trailing slash breaks:**
- nginx forbids URI part in regex `proxy_pass` (including `/`)
- nginx error: `"proxy_pass" cannot have URI part in location given by regular expression`

**Both HTTP (80) and HTTPS (443) blocks must use identical rewrite logic.**

### HTTP Basic Auth Generation at Startup

**GOTCHA:** nginx loads htpasswd file at config parse time. Creating htpasswd AFTER nginx starts doesn't take effect.

**Solution in custom_startup.sh:**
1. Generate htpasswd file with PASSWORD env var (or default "test123")
2. Call `nginx -s reload` to reload config with new credentials
3. Allow 1 second for reload to complete

**PASSWORD env var handling:**
- `if [ -z "${PASSWORD}" ]` checks for unset variable (not just empty string)
- Defaults to "test123" if PASSWORD not provided
- Startup logs indicate whether default or env var was used

### File Manager via gxe

**Implementation:** NHFS (Next-HTTP-File-Server) runs via `PORT=9998 npx -y gxe@latest AnEntrypoint/nhfs`

**Why gxe:** Direct GitHub repo execution without local build system. Simplifies startup sequence.

**Working directory:** NHFS runs from `/config` (home directory for file access)

**Base directory:** NHFS_BASE_DIR env var set to `/config` for file serving


### NHFS basePath Support for Subfolder Deployment

**GOTCHA:** When serving NHFS at a subpath (e.g., `/files/`), all asset requests default to root path.

**Before fix:** NHFS hardcoded paths like `href="/style.css"` and `fetch('/api/list/...')` failed at `/files/` because browser requested `/style.css` instead of `/files/style.css`.

**After fix:** Pass `BASEPATH=/files` environment variable to NHFS:
- Server injects `window.BASEPATH='/files'` into HTML response
- Client-side app reads window.BASEPATH and prepends it to all API calls
- Assets are fetched from `/files/style.css`, API from `/files/api/...`

**Implementation:**
- `server.js`: Read BASEPATH from env, inject into HTML response
- `app.js`: Add `api()` helper method that prepends basePath to all fetch URLs
- `file-manager.js`: Pass `BASEPATH=/files` when launching NHFS via gxe

**Critical:** nginx proxy at `/files/` routes to bare `http://127.0.0.1:9998/` (no URI suffix) so NHFS receives `/files/...` paths from browser.

### Tmux Clipboard Support in webssh2

**GOTCHA:** Clipboard doesn't work in tmux sessions launched via ttyd without explicit xclip configuration.

**Before fix:** Tmux copy mode (vi bindings) didn't integrate with system clipboard. Copy in terminal stayed in tmux buffer only.

**After fix:**
1. Created `/opt/gmweb-startup/tmux.conf` with xclip bindings:
   ```
   bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "xclip -i -selection clipboard"
   bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "xclip -i -selection clipboard"
   set-option -g mouse on
   ```
2. Installed `xclip` system package for clipboard integration
3. webssh2.js loads custom config: `tmux -f /opt/gmweb-startup/tmux.conf new-session ...`

**Result:** Vi mode copy (y, Enter) pipes to system clipboard via xclip. Mouse selection also available.

**Caveat:** xclip requires X11 connection. In headless environments, clipboard may not work. The `2>/dev/null || true` prevents errors on systems without xclip.

### Agent-Browser Pre-Installation

**Implementation:** Auto-install agent-browser during background installation phase.

**Installation steps:**
1. `npm install -g agent-browser` - Global npm package
2. `agent-browser install --with-deps` - Download browser drivers (Chromium, Firefox, etc.)

**Location:** Runs in `install.sh` section 15 (background installs). Executes during startup while UI is already available.

**Caveat:** First boot will pause while agent-browser downloads drivers (~500MB+). Subsequent boots skip this as cache exists. Check logs for installation progress: `tail -f /config/logs/startup.log`.

### AionUI Password Credentials from Environment

**GOTCHA:** AionUI uses better-sqlite3 and bcrypt modules to set login credentials from `$PASSWORD` env var at startup.

**Requirements:**
1. `better-sqlite3` must be installed globally: `npm install -g better-sqlite3`
2. `bcrypt` must be available in npm: `npm install bcrypt` (in /config/node_modules)
3. Password hashing uses bcrypt with cost factor 12, then converts `$2b$` prefix to `$2a$` for AionUI compatibility
4. Credentials set after 8000ms delay to allow AionUI process initialization

**Location:** `startup/services/aion-ui.js` - `setCredentialsFromEnv()` function called 8 seconds after process start

**Environment variables:**
- `PASSWORD` - Primary password env var (fallback)
- `AIONUI_PASSWORD` - Explicit AionUI password (takes precedence)
- `AIONUI_USERNAME` - Custom username (default: "admin")

**Database path:** `/config/.config/AionUi/aionui/aionui.db` - Must exist before credentials update (AionUI creates on first run)

**Module paths (CRITICAL):**
- `better-sqlite3` resolved dynamically via `GLOBAL_MODULES` = `join(dirname(process.execPath), '..', 'lib', 'node_modules')` — never hardcode NVM version paths
- `bcrypt` at `/config/node_modules/bcrypt`

If paths are wrong, credentials setup fails silently - login falls back to AionUI-generated random password.

### precacheNpmPackage Must Be Non-Blocking

**CRITICAL GOTCHA:** `precacheNpmPackage` previously used `execSync` which blocks the entire Node.js event loop for up to 120 seconds. Since all services in a group start via `Promise.all`, a single `execSync` call in any service's `start()` freezes all other services from starting.

**Before fix:** opencode service called `precacheNpmPackage('opencode-ai', env)` with `execSync`, blocking aion-ui from starting for 120 seconds.

**After fix:** Changed to async `spawn()` with `detached: true` and `unref()`. The precache runs in background without blocking the event loop.

### AionUI Download Race Condition Prevention

**GOTCHA:** Health check runs every 30s and re-triggers `downloadAndInstallAionUI()` if binary missing. If previous download attempt failed (3 retries exhausted), the `installationFailed` flag prevents re-triggering, avoiding concurrent curl processes that overwrite each other's partial downloads.

### Webtop Desktop Detection - Replaced Kasm Detection

**GOTCHA:** Old supervisor code waited for `/usr/bin/desktop_ready` (Kasm-specific). Webtop uses different initialization path.

**Fix:** Changed `waitForDesktop()` in `supervisor.js` to check for X11 socket: `/tmp/.X11-unix/1`

**Timeout:** 60 seconds (was 120 for Kasm). If X11 socket doesn't appear, continues anyway with warning.

**Why X11 socket:** Webtop (based on LinuxServer) uses Xvfb for X11 display server. Socket appears once Xvfb starts. More reliable than polling `/usr/bin/desktop_ready` which doesn't exist in Webtop.

### ttyd Binary Installation Timing

**CRITICAL TIMING:** ttyd binary must be installed in PHASE 3.5 (before supervisor starts), not during background installations.

**Problem:** If ttyd only installed during PHASE 5 (background installs), webssh2 service checks `/usr/bin/ttyd` and returns unavailable because supervisor starts immediately after PHASE 4.

**Solution:** Added explicit installation in `custom_startup.sh` PHASE 3.5:
```bash
ARCH=$(uname -m)
TTYD_ARCH=$([ "$ARCH" = "x86_64" ] && echo "x86_64" || echo "aarch64")
TTYD_URL="https://github.com/tsl0922/ttyd/releases/latest/download/ttyd.${TTYD_ARCH}"
TTYD_RETRY=3
while [ $TTYD_RETRY -gt 0 ]; do
  if timeout 60 curl -fL --max-redirs 5 -o /tmp/ttyd "$TTYD_URL" 2>/dev/null && [ -f /tmp/ttyd ] && [ -s /tmp/ttyd ]; then
    sudo mv /tmp/ttyd /usr/bin/ttyd
    sudo chmod +x /usr/bin/ttyd
    break
  fi
done
```

**Includes:** 3 retry attempts, 60-second timeout per attempt, --max-redirs 5 for GitHub redirects.

### NVM Bin Directory Write Permissions

**CRITICAL PERMISSION:** NVM bin directories must have explicit write permissions for abc user to create npm wrapper scripts.

**Problem:** When supervisor tries to create npm wrappers (e.g., `opencode` command), writes fail with EACCES because NVM bin dir is owned by dockremap:dockremap with 755 (not writable by abc).

**Error:** `EACCES: permission denied, open '/usr/local/local/nvm/versions/node/vX.X.X/bin/opencode'`

**Solution:** Add to `custom_startup.sh` after NVM installation:
```bash
chmod 777 $NVM_DIR/versions/node/$(node -v | tr -d 'v')/bin
chmod 777 $NVM_DIR/versions/node/$(node -v | tr -d 'v')/lib/node_modules
```

**Why:** Supervisor runs as abc:abc user. Must have write access to create symlink wrappers for installed packages.

### Supervisor Service Startup Organization

**ARCHITECTURE:** Supervisor organizes services into dependency-based groups, starts groups sequentially, services within each group start in parallel.

**Critical constraint:** `await Promise.all(startPromises)` waits for ALL services in a group to complete before proceeding to next group.

**Problem:** If ANY service in a group hangs indefinitely (e.g., gcloud tries to download 1GB SDK), entire Promise.all() never resolves, supervisor blocks forever.

**Solution:** Disable non-essential services that have hang potential:
- wrangler (unnecessary if not using it)
- gcloud (large SDK download, prone to hanging)
- scrot (screenshot tool)
- glootie-oc (unknown service)
- playwriter (not needed)

**Keep enabled:** webssh2, file-manager, tmux, opencode, aion-ui (essential services).

**Configuration:** `/opt/gmweb-startup/config.json` - Each service has `"enabled": true/false` flag.

### Service Configuration Location

**Path:** Service configuration at `/opt/gmweb-startup/config.json` (NOT `/config/startup/config.json` or `/startup/config.json`).

**Why location matters:** `custom_startup.sh` clones gmweb repo into `/opt/gmweb-startup/` directory, which becomes the base for supervisor initialization.

**Content:** JSON object with services map, each service has `enabled` (boolean) and `type` (install/system/web).

### Supervisor Service Timeout Requirements

**GOTCHA:** Services that start quickly (<10s) don't block startup. Services with large downloads or long initialization timeout as failures.

**Example hang case:** gcloud service tries `curl -sSL https://sdk.cloud.google.com` and pipes to bash, which attempts full SDK installation (~1GB download). If network slow or unavailable, hangs indefinitely.

**Mitigation:** For large-download services, either:
1. Disable them entirely (preferred for startup reliability)
2. Add explicit timeout wrappers
3. Implement health checks that consider timeouts

**Current approach:** Disable services that aren't critical path (gcloud, glootie-oc, etc).

### AionUI Architecture Detection

**GOTCHA:** AionUI .deb download URL must match host architecture (amd64 vs arm64).

**Implementation:** `aion-ui.js` uses GitHub API to find latest release, then selects asset matching `os.arch()` mapped to deb arch (`x64` -> `amd64`, else `arm64`).

**Port:** AionUI listens on port 25808. nginx proxies `/` catch-all to this port.

**Startup behavior:** AionUI downloads and installs in background. Binary at `/opt/AionUi/AionUi`. First boot downloads ~100MB .deb. Subsequent boots skip download if binary exists.

### Supervisor Logging - Duplicate Prevention

**GOTCHA:** supervisor.js was logging every message twice - once via `console.log()` (to stdout) and again to file via `appendFileSync()`. When stdout is piped to a log file by the shell (`>> supervisor.log 2>&1`), each message appears twice.

**Before fix:** 277k lines in supervisor.log in ~6 hours (massive growth, restart loops caused by opencode-acp)

**After fix:** Removed `console.log(formattedMsg)` from the `log()` and `logServiceOutput()` methods. Now only writes to files, not stdout. Shell pipe captures nothing, no duplicates.

**Result:** ~70 lines in first 15 seconds (healthy rate), no duplicate entries.

### Service Restart Loops - opencode-acp Issue

**GOTCHA:** opencode-acp service had indefinite restart loop - health check would timeout (60s), service would fail, restart with 5s backoff, timeout again.

**Root cause:** Health check used simple port listening test. opencode-acp's port 25809 never became reliably available, causing ~60s timeout every health check.

**Log growth impact:** Each cycle = 4-6 log lines + restart attempt. With health checks every 30s, this added ~1000+ lines/hour to supervisor.log (277k lines over 6+ hours).

**Fix:** Disabled opencode service entirely in config.json. Not critical path. Removed restart loop.

**Result:** 0 restart attempts, stable log growth.

### webssh2 Port Binding - Now Fixed

**Note:** webssh2 service (ttyd on port 9999) was initially disabled due to port binding issues. After investigation and testing, determined that port binding is reliable when supervisor manages lifecycle properly.

**Current status:** webssh2 is ENABLED and working. Service provides `/ssh/` endpoint for web terminal access.

**Access:** http://localhost/ssh/ (HTTP Basic Auth required, abc:PASSWORD)

### Log Rotation System

**Implementation:** Added 100MB threshold in supervisor.js `log()` method. When supervisor.log exceeds 100MB, rotated to `supervisor.log.{timestamp}` and new file started.

**Location:** `/config/gmweb/startup/lib/supervisor.js` lines 460-475

**Prevents:** Unbounded log growth. Old logs archived with timestamp for recovery if needed.

### Current Service Configuration (VERIFIED WORKING)

**Enabled (production):**
- webssh2: Web terminal via ttyd, listens on port 9999, proxied to `/ssh/`
- tmux: System terminal multiplexer for webssh2
- aion-ui: Main AI UI application on port 25808

**Disabled (not needed for core functionality):**
- opencode-acp: Not part of critical path
- file-manager: Replaced by nginx routes
- wrangler, gcloud, scrot, playwriter, glootie-oc: Non-essential tools

**Configuration:** `/opt/gmweb-startup/config.json` services map

**Verified startup behavior:** All 3 enabled services start successfully, no restart loops, stable operation.

### PASSWORD-Based Authentication System

**Architecture:** Single PASSWORD environment variable controls all authentication across the entire system.

**Implementation layers:**
1. **nginx (HTTP layer):** HTTP Basic Auth on all routes
   - Uses apr1-hashed PASSWORD in `/etc/nginx/.htpasswd`
   - Generated at startup: `echo "abc:$(openssl passwd -apr1 "$PASSWORD")" > /etc/nginx/.htpasswd`
   - Reloaded: `nginx -s reload`

2. **Supervisor (Process layer):** Passes PASSWORD to all service processes
   - Read in `supervisor.js` during `getEnvironment()`
   - Falls back to 'password' if not set (with WARN log)
   - Environment passed to all child services via `spawnWithEnv()`

3. **Application layer (AionUI):** Uses PASSWORD for database credentials
   - Reads from `AIONUI_PASSWORD` (preferred) or `PASSWORD` fallback
   - Called 8s after AionUI startup to ensure database exists
   - Sets admin user password in `/config/.config/AionUi/aionui/aionui.db`

**Important:** If PASSWORD changes, nginx htpasswd must be regenerated and nginx reloaded for changes to take effect.

### Supervisor Log Files

**Location:** `/config/logs/`

**Files:**
- `supervisor.log`: Main supervisor + all service logs, rotated at 100MB
- `startup.log`: Initial startup output (deprecated, use supervisor.log)
- `services/*.log`: Per-service detailed logs
- `services/*.err`: Per-service error logs only
- `*.archive-{timestamp}`: Rotated log files

**Log index:** `LOG_INDEX.txt` documents log structure

