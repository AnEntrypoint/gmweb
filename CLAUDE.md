# Technical Caveats & Gotchas

## Runtime-Driven Startup Architecture

### Build-Time vs Runtime Split
- **install.sh** runs at `docker-compose build` time (one-time setup)
  - All system packages, software installation
  - Runs as ROOT during Dockerfile RUN command
  - Must be idempotent-free (runs only once)
  - Output captured by docker build

- **start.sh** runs at container BOOT time (every restart)
  - Minimal launcher script (16 lines)
  - Nohups supervisor in background
  - Exits immediately to unblock KasmWeb initialization
  - Must NOT block or wait for anything

- **custom_startup.sh** orchestrator in `/dockerstartup/`
  - KasmWeb native hook that runs at boot
  - Calls start.sh (supervisor launcher)
  - Optionally calls user's `/home/kasm-user/startup.sh` hook if present
  - Exits to allow KasmWeb desktop to continue initializing

**Critical:** custom_startup.sh must exit immediately. If it stays open, KasmWeb desktop initialization is blocked and container becomes unhealthy.

### Supervisor Kasmproxy Prioritization
- Kasmproxy (KasmWeb proxy) **MUST** start FIRST (critical path)
- Supervisor blocks all other 13 services until kasmproxy is healthy
- Health check: verifies port 8000 is listening via `lsof -i :8000`
- Timeout: 2 minutes max wait, then continues anyway
- This ensures service becomes available ASAP (5-10 seconds from boot)

### Environment Variable Passing
- Supervisor extracts VNC_PW from container environment via `/proc/1/environ`
- All services receive environment through `process.env` in node child_process spawn
- **Critical:** Do NOT use template string injection - use explicit env object:
  ```javascript
  const child = spawn(cmd, args, {
    env: { ...process.env, CUSTOM_VAR: value }
  });
  ```
- Services inherit both parent environment AND explicitly set variables

### User Startup Hook Support
- If `/home/kasm-user/startup.sh` exists, custom_startup.sh will execute it
- Called with `bash /home/kasm-user/startup.sh` (no executable bit needed)
- Allows users to add custom boot-time logic without code changes
- Example: Start additional background services, configure dynamic settings

### Service Module Interface
Each of 14 services exports standard interface:
```javascript
{
  name: 'service-name',
  type: 'critical|install|web|system',
  requiresDesktop: true|false,
  dependencies: ['other-service'],
  health: async () => boolean,
  start: async (env) => { pid, process, cleanup },
  stop: async (handle) => void
}
```

- Services with `requiresDesktop: true` wait for `/usr/bin/desktop_ready`
- Dependency resolution via topological sort (prevents circular deps)
- Health checks every 30 seconds

### Immortal Supervisor Guarantees
- **Never crashes**: Global error handlers (uncaughtException, unhandledRejection)
- **Always recovers**: Failed services auto-restart with exponential backoff (5s â†’ 60s max)
- **No mocks/fakes**: All child processes are real, all health checks are real
- **Self-healing**: Continuous monitoring loop with recovery on failure
- **Graceful degradation**: Service max restart attempts = 5, then marked unhealthy but supervisor continues

### Dockerfile Minimal Build
- Only 43 lines total
- Installs only: git, NVM, Node.js 23.11.1
- Runs `bash install.sh` at build time for all system setup
- BuildKit syntax enabled (`# syntax=docker/dockerfile:1.4`)
- Layer caching optimized for fast rebuilds (subsequent builds 2-3 minutes)

### Docker Daemon Requirement
- Local testing requires Docker daemon running
- Build verification uses: `docker build --build-arg ARCH=x86_64 -t gmweb:test .`
- Container startup verification uses: `docker run gmweb:test bash -c "..."`

### Deployment Infrastructure (Coolify)
**Important:** Code is production-ready but deployment requires Coolify domain assignment:
1. Code: All tests pass, all commits pushed, Docker builds cleanly
2. Infrastructure: Requires manual Coolify UI action to assign domain
3. Traefik routing: Auto-generated by Coolify when domain assigned to gmweb service
4. HTTPS: Auto-provisioned by Let's Encrypt (via Coolify)

Without domain assignment in Coolify UI, service returns 502 (no routing rule exists).
