server {
  listen 80 default_server;
  listen [::]:80 default_server;

  root /usr/share/nginx/html;
  index index.html index.htm;

  # Require auth globally
  auth_basic "Login Required";
  auth_basic_user_file /etc/nginx/.htpasswd;

  # Redirect requests without trailing slash to add it (required for alias/proxy_pass to work)
  location = /desk {
    return 301 /desk/;
  }

  location = /ssh {
    return 301 /ssh/;
  }

  location = /files {
    return 301 /files/;
  }

   location = /code {
     return 301 /code/;
   }

   # NHFS asset rewrite - /files uses basePath so assets are at /_next/static/
   # When accessed from /files/, the browser requests /_next/static/ which needs to go to NHFS
   location /_next/ {
     proxy_pass http://127.0.0.1:9998/files/_next/;
     proxy_set_header Host $host;
     proxy_set_header X-Real-IP $remote_addr;
     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
     proxy_set_header X-Forwarded-Proto $scheme;
     proxy_cache_valid 200 1d;
     add_header Cache-Control "public, max-age=31536000, immutable";
   }

   location /desk/ {
    alias /usr/share/selkies/web/;
    index index.html index.htm;
    try_files $uri $uri/ =404;
  }

  location /devmode {
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_connect_timeout 3600s;
    proxy_buffering off;
    client_max_body_size 10M;
    proxy_pass http://127.0.0.1:5173;
  }

  location ~ /desk/websockets? {
    rewrite ^/desk/(.*) /$1 break;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_connect_timeout 3600s;
    proxy_buffering off;
    client_max_body_size 10M;
    proxy_pass http://127.0.0.1:8082;
  }

  location /desk/files {
    fancyindex on;
    fancyindex_footer /desk/nginx/footer.html;
    fancyindex_header /desk/nginx/header.html;
    alias /config/Desktop/;
    if (-f $request_filename) {
      add_header Content-Disposition "attachment";
      add_header X-Content-Type-Options "nosniff";
    }
  }

  location /ui/ {
    proxy_pass http://127.0.0.1:9997/;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_connect_timeout 3600s;
    proxy_buffering off;
    client_max_body_size 10M;
  }

  location /api/ {
    proxy_pass http://127.0.0.1:9997/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location /ws/ {
    proxy_pass http://127.0.0.1:9997/;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_buffering off;
  }

   location /ssh/ {
     proxy_pass http://127.0.0.1:9999/;
     proxy_set_header Upgrade $http_upgrade;
     proxy_set_header Connection "upgrade";
     proxy_set_header Host $host;
     proxy_set_header X-Real-IP $remote_addr;
     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
     proxy_set_header X-Forwarded-Proto $scheme;
     proxy_http_version 1.1;
     proxy_read_timeout 3600s;
     proxy_send_timeout 3600s;
     proxy_buffering off;
    }

      location /files/ {
        proxy_pass http://127.0.0.1:9998/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_request_buffering off;
        client_max_body_size 100M;
      }

        location /code/ {
        # Disable nginx auth for /code/ - OpenCode has its own authentication
        auth_basic off;
        
        proxy_pass http://127.0.0.1:9997/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 3600s;
        proxy_buffering off;
        client_max_body_size 10M;

        # CORS headers for external domain access
        add_header 'Access-Control-Allow-Origin' '$http_origin' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

        # Content-Security-Policy for OpenCode to work properly
        add_header 'Content-Security-Policy' "default-src 'self' https:; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self' https: wss:; frame-src 'self' https:;" always;

        # Handle OPTIONS requests (CORS preflight)
        if ($request_method = 'OPTIONS') {
          return 204;
        }
       }

     # OpenCode assets and static files
     location /assets/ {
       proxy_pass http://127.0.0.1:9997/assets/;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
     }

     location ~ ^/(favicon|apple-touch-icon|site\.webmanifest|oc-theme|social-share) {
       proxy_pass http://127.0.0.1:9997;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
     }

     # OpenCode API endpoints
     location ~ ^/(global|path|project|provider|session|agent|config|command|mcp|lsp|vcs|permission|question|find)(/|$) {
       proxy_pass http://127.0.0.1:9997;
       proxy_set_header Upgrade $http_upgrade;
       proxy_set_header Connection "upgrade";
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
       proxy_http_version 1.1;
       proxy_buffering off;
     }

    error_page 500 502 503 504 /50x.html;
   location = /desk/50x.html {
     root /usr/share/selkies/web/;
   }
}

server {
  listen 443 ssl;
  listen [::]:443 ssl;
  ssl_certificate /config/ssl/cert.pem;
  ssl_certificate_key /config/ssl/cert.key;

  root /usr/share/nginx/html;
  index index.html index.htm;

  # Require auth globally
  auth_basic "Login Required";
  auth_basic_user_file /etc/nginx/.htpasswd;

  # Redirect requests without trailing slash to add it (required for alias/proxy_pass to work)
  location = /desk {
    return 301 /desk/;
  }

  location = /ssh {
    return 301 /ssh/;
  }

  location = /files {
    return 301 /files/;
  }

  location /desk/ {
    alias /usr/share/selkies/web/;
    index index.html index.htm;
    try_files $uri $uri/ =404;
  }

  location /devmode {
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_connect_timeout 3600s;
    proxy_buffering off;
    client_max_body_size 10M;
    proxy_pass http://127.0.0.1:5173;
  }

  location ~ /desk/websockets? {
    rewrite ^/desk/(.*) /$1 break;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_connect_timeout 3600s;
    proxy_buffering off;
    client_max_body_size 10M;
    proxy_pass http://127.0.0.1:8082;
  }

  location /desk/files {
    fancyindex on;
    fancyindex_footer /desk/nginx/footer.html;
    fancyindex_header /desk/nginx/header.html;
    alias /config/Desktop/;
    if (-f $request_filename) {
      add_header Content-Disposition "attachment";
      add_header X-Content-Type-Options "nosniff";
    }
  }

  location /ui/ {
    proxy_pass http://127.0.0.1:9997/;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_connect_timeout 3600s;
    proxy_buffering off;
    client_max_body_size 10M;
  }

  location /api/ {
    proxy_pass http://127.0.0.1:9997/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location /ws/ {
    proxy_pass http://127.0.0.1:9997/;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_buffering off;
  }

  location /ssh/ {
    proxy_pass http://127.0.0.1:9999/;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_buffering off;
  }

    location /files/ {
      proxy_pass http://127.0.0.1:9998/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      client_max_body_size 100M;
    }

    location /code/ {
      # Disable nginx auth for /code/ - OpenCode has its own authentication
      auth_basic off;
      
      proxy_pass http://127.0.0.1:9997/;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_http_version 1.1;
      proxy_read_timeout 3600s;
      proxy_send_timeout 3600s;
      proxy_connect_timeout 3600s;
      proxy_buffering off;
      client_max_body_size 10M;
    }

     # OpenCode assets and static files
     location /assets/ {
       proxy_pass http://127.0.0.1:9997/assets/;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
     }

     location ~ ^/(favicon|apple-touch-icon|site\.webmanifest|oc-theme|social-share) {
       proxy_pass http://127.0.0.1:9997;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
     }

     # OpenCode API endpoints
     location ~ ^/(global|path|project|provider|session|agent|config|command|mcp|lsp|vcs|permission|question|find)(/|$) {
       proxy_pass http://127.0.0.1:9997;
       proxy_set_header Upgrade $http_upgrade;
       proxy_set_header Connection "upgrade";
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
       proxy_http_version 1.1;
       proxy_buffering off;
     }

    error_page 500 502 503 504 /50x.html;
    location = /desk/50x.html {
      root /usr/share/selkies/web/;
    }
}
